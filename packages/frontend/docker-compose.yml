# File Path: docker-compose.yml
# Version: 1.1.0
#
# Description:
# Updated Docker Compose configuration for Rust backend.
# Minimal changes to support the Rust backend while maintaining Python runner.
#
# Key Features:
# - Rust backend container
# - Python runner container (unchanged)
# - Shared volumes and networks
# - Health checks
#
# Usage Guide:
# docker-compose up -d --build
# docker-compose logs -f rust_backend

version: "3.8"

services:
  # =============================================================================
  # RUST BACKEND SERVICE
  # =============================================================================
  rust_backend:
    container_name: rust_backend
    build:
      context: ./packages/backend
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Map the new shared data directory
      - ./packages/shared:/app/shared:ro
      # Map the python scripts needed for execution
      - ./packages/frontend/xaospy:/app/xaospy:ro
    environment:
      RUST_LOG: "debug,rust_backend=debug"
      HOST_PROJECT_ROOT: "${PROJECT_ROOT}"
    depends_on:
      - python_runner
    restart: unless-stopped
    networks:
      - vlabs-net

  # =============================================================================
  # PYTHON RUNNER SERVICE
  # =============================================================================
  python_runner:
    container_name: python_runner
    image: python-runner
    build:
      context: ./packages/frontend/xaospy
      dockerfile: Dockerfile
    command: tail -f /dev/null
    volumes:
      # Map the python project directory
      - ./packages/frontend/xaospy:/xaospy
      # Map the shared data directory
      - ./packages/shared:/shared
    networks:
      - vlabs-net

networks:
  vlabs-net:
    driver: bridge
